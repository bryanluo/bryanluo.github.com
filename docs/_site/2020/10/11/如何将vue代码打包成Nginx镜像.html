<h2 id="实现将vue项目打包成docker镜像">实现将Vue项目打包成Docker镜像</h2>

<h2 id="1先在-vue-项目下添加一个-configjs-并使用变量-api_base_url-作为占位符">1、先在 Vue 项目下添加一个 config.js 并使用变量 API_BASE_URL 作为占位符：</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">environment</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">BASE_URL</span><span class="dl">'</span>
<span class="p">};</span>

</code></pre></div></div>
<p>在其他页面要应用该变量，具体引用代码：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">baseUrl</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">config.js</span><span class="dl">"</span>
</code></pre></div></div>

<p>2、编写 Dockerfile 文件</p>

<p>Dockerfile:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 指定镜像运行环境</span>
<span class="s">FROM node:10-alpine as build</span>

<span class="c1"># 安装且存储依赖</span>
<span class="s">RUN mkdir /app</span>
<span class="s">COPY . /app</span>
<span class="s">WORKDIR /app</span>
<span class="s">RUN npm config set registry https://registry.npm.taobao.org  &amp;&amp; npm install &amp;&amp; npm run build</span> 

<span class="c1"># nginx 环境构建</span>
<span class="s">FROM nginx</span>
<span class="s">COPY default.conf /etc/nginx/conf.d/default.conf</span>
<span class="s">COPY --from=build  /app/dist /usr/share/nginx/html/</span>
<span class="s">COPY --from=build /app/replace.sh /</span>
<span class="s">EXPOSE </span><span class="m">8080</span>
<span class="s">LABEL MAINTAINER="shijiang.luo"</span>
<span class="s">CMD [ "sh", "replace.sh" ]</span>
</code></pre></div></div>

<p>default.conf</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">server{</span>
    <span class="s">listen 8080;</span>
    <span class="s">server_name localhost;</span>

    <span class="s">location / {</span>
        <span class="s">root /usr/share/nginx/html/;</span>
        <span class="s">index index.html;</span>
    <span class="s">}</span>

    <span class="s">error_page 500 502 503 504 /50x.html;</span>
    <span class="s">location = /50x.html {</span>
        <span class="s">root /usr/share/nginx/html;</span>
    <span class="s">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h2 id="3使用脚本替换项目中所有-js-文件的占位符">3、使用脚本替换项目中所有 JS 文件的占位符</h2>

<p>replace_api_url.sh :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash/env sh</span>
find <span class="s1">'/usr/share/nginx/html'</span> <span class="nt">-name</span> <span class="s1">'*.js'</span> <span class="nt">-exec</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s,API_BASE_URL,'</span><span class="s2">"</span><span class="nv">$API_BASE_URL</span><span class="s2">"</span><span class="s1">',g'</span> <span class="o">{}</span> <span class="se">\;</span>
nginx <span class="nt">-g</span> <span class="s2">"daemon off;"</span>
</code></pre></div></div>

<h2 id="4正常构建镜像并使用环境变量传参替换原前端的占位符-api_base_url">4、正常构建镜像，并使用环境变量传参替换原前端的占位符 API_BASE_URL</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker build <span class="nt">-t</span> <span class="nb">test</span> <span class="nb">.</span>
 
 docker run <span class="nt">-itd</span> <span class="nt">-p</span> 8080:8080 <span class="nt">-e</span> <span class="nv">API_BASE_URL</span><span class="o">=</span>http://hellojiang.top <span class="nb">test</span>
</code></pre></div></div>

<h2 id="5总结">5、总结</h2>

<p>利用 CMD 在容器启动时才执行的特性，在 Vue 容器启动时执行 replace_api_url.sh 脚本， 实现将 *.js 里面的占位符全部替换成我们所想的即可。</p>
